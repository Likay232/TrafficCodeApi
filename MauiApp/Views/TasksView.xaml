<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:MauiApp.ViewModels"
             xmlns:dto="clr-namespace:MauiApp.Infrastructure.Models.DTO;assembly=MauiApp.Infrastructure"
             x:Class="MauiApp.Views.TasksView"
             x:DataType="viewModels:TasksViewModel"
             Title="Задачи">

    <Shell.BackButtonBehavior>
        <BackButtonBehavior Command="{Binding BackCommand}" />
    </Shell.BackButtonBehavior>

    <Grid RowDefinitions="*,Auto">

        <!-- Контент -->
        <ScrollView Grid.Row="0">
            <CollectionView ItemsSource="{Binding Model}"
                            Margin="10"
                            BackgroundColor="White">

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dto:TaskForTest">
                        <Frame Padding="15"
                               Margin="10,6"
                               CornerRadius="12"
                               BorderColor="#DDD"
                               BackgroundColor="#FAFAFA"
                               HasShadow="True">

                            <VerticalStackLayout Spacing="12">

                                <Image Source="{Binding LocalPath}"
                                       HeightRequest="180"
                                       Aspect="AspectFit"
                                       IsVisible="{Binding LocalPath, Converter={StaticResource NullToBoolConverter}}" />

                                <Label Text="{Binding Text}"
                                       FontSize="17"
                                       FontAttributes="Bold"
                                       TextColor="#333" />

                                <VerticalStackLayout Spacing="6">
                                    <Label Text="Варианты ответов:"
                                           FontSize="14"
                                           TextColor="#666" />

                                    <CollectionView ItemsSource="{Binding AnswerVariantsWithFlag}"
                                                    SelectionMode="None">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="dto:AnswerVariant">
                                                <Frame Padding="10"
                                                       CornerRadius="8"
                                                       BorderColor="#CCC"
                                                       BackgroundColor="#FFFFFF">
                                                    <Frame.Triggers>
                                                        <DataTrigger TargetType="Frame"
                                                                     Binding="{Binding IsCorrect}"
                                                                     Value="True">
                                                            <Setter Property="BackgroundColor" Value="LightGreen" />
                                                            <Setter Property="BorderColor" Value="Green" />
                                                        </DataTrigger>
                                                    </Frame.Triggers>
                                                    <Label Text="{Binding Text}"
                                                           FontSize="15"
                                                           TextColor="#222" />
                                                </Frame>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>
                                </VerticalStackLayout>

                                <Frame Padding="10"
                                       CornerRadius="8"
                                       BackgroundColor="#FFF8DC"
                                       BorderColor="#E0C97F">
                                    <Label Text="{Binding Hint}"
                                           FontSize="14"
                                           TextColor="#555"
                                           FontAttributes="Italic" />
                                </Frame>

                                <Label Text="{Binding DifficultyLevel, StringFormat='Сложность: {0}'}"
                                       FontSize="13"
                                       TextColor="#888"
                                       HorizontalOptions="End" />

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>

        <Button Grid.Row="1"
                Text="Пройти тест"
                Margin="10"
                HeightRequest="50"
                CornerRadius="10"
                Clicked="GenerateTestClicked" />

        <Grid Grid.RowSpan="2"
              IsVisible="{Binding IsLoading}"
              BackgroundColor="#88000000"
              InputTransparent="False">
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               Color="White"
                               WidthRequest="50"
                               HeightRequest="50"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
        </Grid>

    </Grid>
</ContentPage>